<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inspiration Clock</title>
<style>
  :root { --bg: url("%%IMAGE_URL%%"); }
  html, body { height: 100%; }
  body {
    margin: 0; overflow: hidden; background: #111; color: #fff;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
  }
  body::before {
    content: ""; position: fixed; inset: 0; z-index: 0;
    background-image: var(--bg); background-position: center; background-size: cover;
    filter: blur(24px) brightness(0.9); transform: scale(1.1);
  }
  .wallpaper {
    position: fixed; inset: 0; z-index: 1;
    background-image: var(--bg); background-repeat: no-repeat;
    background-position: center; background-size: contain;
  }
.clock {
  position: fixed;
  top: 33%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2;

  width: 50%;
  max-width: var(--img-w, 100vw);
  text-align: center;

  /* background box styling */
  padding: 16px 24px;
  border-radius: 16px;
  background: rgba(0,0,0,.25);
  backdrop-filter: blur(8px);
  text-shadow: 0 3px 14px rgba(0,0,0,.6);
}

#clock-time {
  display: block;
  width: 100%;             /* text spans full clock box */
  font-variant-numeric: tabular-nums;
  font-weight: 700;
  letter-spacing: .04em;
  line-height: 1.1;

  /* scale font to ~50% of image width */
  font-size: calc(var(--img-w, 100vw) * 0.5 / 5); 
  /* Explanation: divide by ~5 to fit HH:MM comfortably; tweak divisor if text is too big/small */
}

#clock-date {
  display: block;
  margin-top: 0.25em;
  font-size: 0.4em;   /* scales with #clock-time */
  font-weight: 500;
  opacity: 0.9;
}
  
#fs-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 3;

  background: rgba(0,0,0,0.4);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  font-size: 20px;
  cursor: pointer;

  backdrop-filter: blur(6px);

  opacity: 1;
  transition: opacity 0.5s ease;
}
#fs-btn.hidden {
  opacity: 0;
  pointer-events: none; /* avoid accidental clicks when hidden */
}

</style>
</head>
<body>
  <div class="wallpaper" role="img" aria-label="Inspirational wallpaper"></div>
  <div class="clock">
    <div id="clock-time" style="font-size: 1em;">--:--</div>
    <div id="clock-date" style="font-size: 0.45em; font-weight: 500; opacity: 0.9;">—</div>
  </div>
  <button id="fs-btn" title="Fullscreen">⛶</button>

<script>
  const WEEKDAYS = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  function pad2(n){ return String(n).padStart(2,"0"); }

  function tick(){
    const d = new Date();

    // Time (HH:MM AM/PM)
    let hours = d.getHours();
    const minutes = pad2(d.getMinutes());
    const ampm = hours >= 12 ? "PM" : "AM";
    hours = hours % 12;
    if (hours === 0) hours = 12;
    document.getElementById("clock-time").textContent = `${hours}:${minutes} ${ampm}`;

    // Date (Weekday, Mon DD)
    const weekday = WEEKDAYS[d.getDay()];
    const mon = MONTHS[d.getMonth()];
    const day = d.getDate();
    document.getElementById("clock-date").textContent = `${weekday}, ${mon} ${day}`;
  }

  function scheduleMidnightReload() {
    const now = new Date();
    const msUntilMidnight = new Date(
      now.getFullYear(), now.getMonth(), now.getDate()+1, 0, 0, 5
    ) - now;
    setTimeout(() => location.reload(true), msUntilMidnight);
  }

  tick();
  setInterval(tick, 15 * 1000);
  scheduleMidnightReload();

  // --- Wake Lock to prevent screen sleep ---
  let wakeLock = null;
  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log("[WakeLock] Screen lock acquired");
        wakeLock.addEventListener('release', () => {
          console.log('[WakeLock] Screen lock released');
        });
      } else {
        console.log("[WakeLock] API not supported in this browser");
      }
    } catch (err) {
      console.error(`[WakeLock] Error: ${err.name}, ${err.message}`);
    }
  }
  requestWakeLock();

  // Re-request on visibility change
  document.addEventListener('visibilitychange', () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
      requestWakeLock();
    }
  }); // <-- was missing

  // --- Fullscreen toggle ---
  const fsBtn = document.getElementById("fs-btn");

  async function toggleFullscreen() {
    if (!document.fullscreenElement) {
      try {
        await document.documentElement.requestFullscreen();
        fsBtn.textContent = "⤫";
      } catch (err) {
        console.error("[Fullscreen] Error:", err);
      }
    } else {
      try {
        await document.exitFullscreen();
        fsBtn.textContent = "⛶";
      } catch (err) {
        console.error("[Fullscreen] Error:", err);
      }
    }
  }
  fsBtn.addEventListener("click", toggleFullscreen);

  // Update button icon when user exits via Esc
  document.addEventListener("fullscreenchange", () => {
    if (!document.fullscreenElement) {
      fsBtn.textContent = "⛶";
    }
  }); // <-- was missing

  // --- Auto-hide fullscreen button after inactivity ---
  let hideTimeout;
  function showButton() {
    const btn = document.getElementById("fs-btn");
    btn.classList.remove("hidden");
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      btn.classList.add("hidden");
    }, 3000);
  }

  ["mousemove","keydown","touchstart"].forEach(evt => {
    document.addEventListener(evt, showButton);
  });

  // Start hidden on load
  document.getElementById("fs-btn").classList.add("hidden");

//JS to compute visible image width
  function extractBgUrl(str){
  // background-image: url("https://..."), possibly with quotes
  const match = str.match(/url\((['"]?)(.*?)\1\)/i);
  return match ? match[2] : null;
}

function computeContainWidth(vw, vh, imgW, imgH){
  // For background-size: contain → scale = min(vw/imgW, vh/imgH)
  const scale = Math.min(vw / imgW, vh / imgH);
  return imgW * scale; // displayed width in CSS pixels
}

async function setClockMaxWidthFromImage(){
  try {
    const wp = document.querySelector('.wallpaper');
    if (!wp) return;

    const style = getComputedStyle(wp);
    const bgUrl = extractBgUrl(style.backgroundImage);
    if (!bgUrl) return;

    // Load the image to get intrinsic size
    const img = new Image();
    img.decoding = 'async';
    img.src = bgUrl;

    // Wait until loaded (cached loads resolve immediately)
    await (img.complete ? Promise.resolve() : new Promise((res, rej)=>{
      img.onload = res; img.onerror = rej;
    }));

    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const dispW = computeContainWidth(vw, vh, img.naturalWidth, img.naturalHeight);

    // Expose to CSS
    document.documentElement.style.setProperty('--img-w', dispW + 'px');
  } catch (e) {
    console.warn('[clock-width]', e);
  }
}

// Run now and on resize/orientation changes
setClockMaxWidthFromImage();
addEventListener('resize', setClockMaxWidthFromImage);
addEventListener('orientationchange', setClockMaxWidthFromImage);

  
</script>

</body>
</html>
